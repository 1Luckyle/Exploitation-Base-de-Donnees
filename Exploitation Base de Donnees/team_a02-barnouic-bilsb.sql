/* Quel lien peut-on établir entre le nutriscore (A,B,C,D,E) et les variables nutrionnelles 
pour les produits de la famille 'en:cereals' aux Etats-Unis ? */

/* psql -h postgres-info openfoodfacts -U team_a02
   Clement BARNOUIN
   Binome : bilsb
   Utilisateur postgresql : team_a02
   avec le mot de passe : eizahV1a */

/* SET client_encoding TO UTF8;
   Permet de lever les erreurs d'encodage mais les caractères "spéciaux" sont mal "traduits" */

/* Création de la table temporaire - Version 1 */
CREATE TEMP TABLE usacereals AS
SELECT 
   code,
   url,
   product_name,
   brands_tags,
   stores,
   owner,
   food_groups,
   labels_tags,
   countries,
   countries_tags,
   quantity,
   fat_100g,
   saturated_fat_100g,
   sugars_100g,
   proteins_100g,
   carbohydrates_100g,
   energy_100g,
   salt_100g,
   sodium_100g,
   nutriscore_score,
   nutriscore_grade,
   ingredients_analysis_tags,
   nutrient_levels_tags
FROM openfoodfacts
WHERE countries_tags LIKE '%en:united-states%'
    AND food_groups = 'en:cereals'
    AND data_quality_errors_tags IS NULL;

/* 
DROP TABLE usacereals; 
*/

/* Extraction et Nettoyage */
/* Suppression des lignes contenant des valeurs manquantes pour les champs code et nutriscore_grade */
DELETE FROM usacereals WHERE code IS NULL OR nutriscore_grade IS NULL;

/* Suppression des lignes contenant un code erronné "!= 13 caractères" */
DELETE FROM usacereals WHERE LENGTH(code) != 13;

/* Suppression des lignes où les valeurs des champs se terminant par "_100g" qui sont négatif ou supérieur à 100 */
DELETE FROM usacereals
WHERE 
    (fat_100g < 0 OR fat_100g > 100)
    OR (saturated_fat_100g < 0 OR saturated_fat_100g > 100)
    OR (sugars_100g < 0 OR sugars_100g > 100)
    OR (proteins_100g < 0 OR proteins_100g > 100)
    OR (carbohydrates_100g < 0 OR carbohydrates_100g > 100)
    OR (salt_100g < 0 OR salt_100g > 100)
    OR (sodium_100g < 0 OR sodium_100g > 100);

/* Calcul de la valeur du champ computed_energy_100g_KJ (en kilojoules) */
ALTER TABLE usacereals ADD COLUMN computed_energy_100g_KJ DECIMAL;

UPDATE usacereals SET computed_energy_100g_KJ = 
    (fat_100g * 37) + (carbohydrates_100g * 17) + (proteins_100g * 17);

/* Remarque : Cette formule est basée sur l'approximation utilisée par Open Food Facts pour calculer l'énergie en kilojoules. La documentation peut être trouvée ici : https://fr.openfoodfacts.org/score-nutritionnel-france#comment-sont-calculees-les-contributions-energetiques, https://inspection.canada.ca/etiquetage-des-aliments/etiquetage/industrie/etiquetage-nutritionnel/elements-du-tableau-de-la-valeur-nutritive/fra/1613599715710/1613599936553 et https://www.youtube.com/watch?v=xwDu_sQMww4 */

/* Ajout du champ bio */
ALTER TABLE usacereals ADD COLUMN organic BOOLEAN;

UPDATE usacereals SET organic = CASE WHEN labels_tags LIKE '%en:organic%' THEN TRUE ELSE FALSE END;

/* Ajout des champs vegan, vegetarian et palm_oil depuis "ingredients_analysis_tags" */
ALTER TABLE usacereals ADD COLUMN vegan CHAR(1), ADD COLUMN vegetarian CHAR(1), ADD COLUMN palm_oil CHAR(1);

UPDATE usacereals SET
    vegan = CASE WHEN ingredients_analysis_tags LIKE '%en:vegan%' THEN 't'
                 WHEN ingredients_analysis_tags LIKE '%en:non-vegan%' THEN 'f'
                 ELSE NULL END,
    vegetarian = CASE WHEN ingredients_analysis_tags LIKE '%en:vegetarian%' THEN 't'
                      WHEN ingredients_analysis_tags LIKE '%en:non-vegetarian%' THEN 'f'
                      ELSE NULL END,
    palm_oil = CASE WHEN ingredients_analysis_tags LIKE '%en:palm-oil%' THEN 't'
                     WHEN ingredients_analysis_tags LIKE '%en:no-palm-oil%' THEN 'f'
                     ELSE NULL END;

/* Ajout des champs level_fat, level_saturated_fat et level_sugars depuis "nutrient_levels_tags" */
ALTER TABLE usacereals ADD COLUMN level_fat CHAR(1), ADD COLUMN level_saturated_fat CHAR(1), ADD COLUMN level_sugars CHAR(1), ADD COLUMN level_salt CHAR(1);

UPDATE usacereals SET
    level_fat = CASE WHEN nutrient_levels_tags LIKE '%en:fat-in-high-quantity%' THEN 'h'
                     WHEN nutrient_levels_tags LIKE '%en:fat-in-moderate-quantity%' THEN 'm'
                     WHEN nutrient_levels_tags LIKE '%en:fat-in-low-quantity%' THEN 'l'
                     ELSE NULL END,
    level_saturated_fat = CASE WHEN nutrient_levels_tags LIKE '%en:saturated-fat-in-high-quantity%' THEN 'h'
                                WHEN nutrient_levels_tags LIKE '%en:saturated-fat-in-moderate-quantity%' THEN 'm'
                                WHEN nutrient_levels_tags LIKE '%en:saturated-fat-in-low-quantity%' THEN 'l'
                                ELSE NULL END,
    level_sugars = CASE WHEN nutrient_levels_tags LIKE '%en:sugars-in-high-quantity%' THEN 'h'
                         WHEN nutrient_levels_tags LIKE '%en:sugars-in-moderate-quantity%' THEN 'm'
                         WHEN nutrient_levels_tags LIKE '%en:sugars-in-low-quantity%' THEN 'l'
                         ELSE NULL END,
    level_salt = CASE WHEN nutrient_levels_tags LIKE '%en:salt-in-high-quantity%' THEN 'h'
                         WHEN nutrient_levels_tags LIKE '%en:salt-in-moderate-quantity%' THEN 'm'
                         WHEN nutrient_levels_tags LIKE '%en:salt-in-low-quantity%' THEN 'l'
                         ELSE NULL END;


/* Nettoyage des doublons */
/* Suppression des doublons basés sur les valeurs des champs non calculés (sauf code et url) */
DELETE FROM usacereals
WHERE (product_name, fat_100g, saturated_fat_100g, sugars_100g, proteins_100g, carbohydrates_100g, energy_100g, salt_100g, sodium_100g, ingredients_analysis_tags, nutrient_levels_tags) 
    IN (SELECT product_name, fat_100g, saturated_fat_100g, sugars_100g, proteins_100g, carbohydrates_100g, energy_100g, salt_100g, sodium_100g, ingredients_analysis_tags, nutrient_levels_tags
        FROM (SELECT product_name, fat_100g, saturated_fat_100g, sugars_100g, proteins_100g, carbohydrates_100g, energy_100g, salt_100g, sodium_100g, ingredients_analysis_tags, nutrient_levels_tags,
                     ROW_NUMBER() OVER (PARTITION BY product_name, fat_100g, saturated_fat_100g, sugars_100g, proteins_100g, carbohydrates_100g, energy_100g, salt_100g, sodium_100g, ingredients_analysis_tags, nutrient_levels_tags ORDER BY code) AS row_num
             FROM usacereals) AS sub
        WHERE row_num > 1);

/* Suppression des doublons basés sur les codes-barres */
DELETE FROM usacereals
WHERE code IN (SELECT code
               FROM (SELECT code, COUNT(*) AS count
                     FROM usacereals
                     GROUP BY code
                     HAVING COUNT(*) > 1) AS sub);

/* Dernier nettoyage */
ALTER TABLE usacereals
DROP COLUMN ingredients_analysis_tags,
DROP COLUMN nutrient_levels_tags;


/* Vérification du nombre de lignes final */
SELECT count(*) FROM usacereals;
/* count 
  -------
   13349 */


/* Exportation */
\COPY usacereals TO 'Desktop/S2/S2.04/team_a02-barnouic-bilsb.csv' WITH CSV DELIMITER E'\t' NULL 'NA' HEADER ENCODING 'UTF8'; 